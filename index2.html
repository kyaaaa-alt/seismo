<html>

<head>
  <meta name="viewport" content="width=device-width, user-scalable=no">
  <title>Earthquake Early Warning</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
    integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
    crossorigin="anonymous"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.2/font/bootstrap-icons.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;600&display=swap" rel="stylesheet">
  <script src="gyronorm.complete.min.js"></script>
  <script src="mobile-detect.js"></script>
  <style type="text/css">
    body {
      background-color: #283039;
    }

    .container {
      margin-top: 20px;
    }

    .tab-pane {
      margin-top: 15px;
    }

    .page-header {
      margin-top: 20px;
    }

    .input-group {
      margin-bottom: 20px;

    }

    input[type=text],
    textarea {
      box-shadow: none;
      -webkit-appearance: none;
      -webkit-box-shadow: none !important;
      -moz-box-shadow: none !important;
      box-shadow: none !important;
    }

    .col-xs-12 {
      color: #fff !important;
      background-color: #1d1d1d !important;
    }

    #dm .input-group {
      float: left;
      padding-left: 10px;
    }

    #dm .input-group.first {
      padding-left: 0px;
    }

    #dm .col-xs-12 {
      padding-left: 0;
    }
  </style>

</head>

<body onload="init_gn()">

  <div class="container">

    <div role="tabpanel">
      <!-- Nav tabs -->
      <ul id="menu" class="nav nav-pills" role="tablist">
        <li role="presentation"><a href="#do" aria-controls="do" role="tab" data-toggle="tab">Orientation</a></li>
        <li role="presentation"><a href="#dm" aria-controls="dm" role="tab" data-toggle="tab">Motion</a></li>
        <li role="presentation" class="active"><a href="#logs" aria-controls="logs" role="tab"
            data-toggle="tab">Logs</a></li>
      </ul>

      <!-- Tab panes -->
      <div class="tab-content">

        <div role="tabpanel" class="tab-pane" id="do">

          <input type="button" onclick="set_head_gn()" value="Set Head Direction" class="col-xs-12 btn-warning btn" />

        </div>
        <div role="tabpanel" class="tab-pane" id="dm">

        </div>
        <div role="tabpanel" class="tab-pane active" id="logs">
          <div class="text-center mt-3">
            <h3 class="text-white"><i class="bi bi-heart-pulse"></i> Earthquake Early
              Warning</h3>
            <span id="jam" class="badge"></span>
          </div>

          <div class="alert alert-warning alert-dismissible fade show mt-3" role="alert">
            <small>Mohon untuk mengaktifkan mode suara.</small>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>

          <div class="alert alert-info alert-dismissible fade show" role="alert">
            <small>- Belum bisa digunakan pada iOS / iPhone. <br>
              - Mohon baca <a type="button" class="text-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">
                panduan penggunaan.</a> </small>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>

          <div id="settings">
            <div class="text-center mt-4">
              <input type="button" onclick="start_gn()" value="START" class="btn-success btn btn-lg mx-2" />
              <input type="button" onclick="stop_gn()" value="STOP" class="btn-danger btn btn-lg mx-2" />
            </div>
            <div class="text-center mt-4">
              <span id="aktif" class="badge text-bg-success">ALARM
                AKTIF</span>
              <span id="tidakaktif" class="badge text-bg-warning">ALARM TIDAK AKTIF</span>
            </div>
            <div id="sens" class="mt-4">
              <label for="sele" class="text-white mb-1">Tingkat sensitivitas getaran.</label>
              <select id="sele" class="form-control col-xs-12">
                <option value="1">[Level 1] Sangat Sensitif</option>
                <option value="2">[Level 2] Sensitif</option>
                <option value="3">[Level 3] Normal</option>
                <option value="4">[Level 4] Sensitif Sedang</option>
                <option value="5">[Level 5] Kurang Sensitif</option>
              </select>
            </div>
          </div>

          <textarea class="col-xs-12 form-control" id="error-message" rows="7"
            style="margin-top: 10px !important;margin-bottom: 10px;" placeholder="Log area..." disabled></textarea>
          <!-- <textarea class="col-xs-12 form-control" rows="8" style="margin-top: 10px !important;margin-bottom: 10px;"
            placeholder="Log area..." disabled>
Update :
- Penambahan level tingkat sensitivitas.
- Untuk mengubah sensitivitas, harap stop alarm terlebih dahulu.

Informasi :
- Belum bisa digunakan pada iOS / iPhone.
- Harap baca panduan, klik tombol panduan di bawah
            </textarea> -->
          <div class="text-center">
            <div class="mt-3">
              <button type="button" class="btn btn-outline-info btn-sm" data-bs-toggle="modal"
                data-bs-target="#exampleModal">
                Panduan
              </button>
            </div>
            <div class="mt-3">
              <p class="text-white">#SemogaLekasPulih</p>

              <a href="https://saweria.co/kolbyart" type="button" class="btn btn-success btn-sm col-6"><i
                  class="bi bi-cash-stack"></i> Donasi</a>

            </div>
          </div>
          <div class="mb-4"></div>
          <div class="text-center mb-4">
            <small class="text-white-50" style="font-size: 9px;">Develop by <a class="text-decoration-none text-white"
                href="https://nauf.space/donate">Naufal
                Azkia</a></small>
          </div>

        </div>
      </div>

    </div>

  </div>

  <!-- Modal -->
  <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog container">
      <div class="modal-content">
        <div class="modal-body" style="background-color: #1d1d1d !important;padding:10px;border: 1px solid gray;">
          <p style="color:#fff;">Situs ini menggunakan Sensor <i>Gyroscope Accelerometer</i> pada perangkat smartphone
            atau tablet anda, jika sensor mendeteksi getaran, maka akan muncul suara peringatan.</p>

          <p style="color:#fff;"><b>Cara menggunakan : </b>Sebelum anda menekan tombol <b>[START]</b>, nyalakan mode
            suara kemudian simpan smartphone ditempat yang mudah terguncang. <br>
            Anda bisa menyimpan handphone dengan posisi miring bersandar. <br>
            setelah disimpan, pastikan handphone tidak bergerak sama sekali, lalu
            klik tombol <b>[START]</b>.</p>

          <p style="color:#fff;"><b>Catatan : </b>Disarankan menggunakan <b>Browser Google Chrome</b> terbaru. jika
            menggunakan browser lain, anda harus mengatur smartphone anda agar hp tetap menyala dan tetap diposisi situs
            ini, karena alarm tidak akan berfungsi apabila smartphone dalam keadaan Screenlock / Layar Terkunci / Layar
            Mati. </p>
          <div style="text-align: center;">
            <a class="btn btn-danger" data-bs-dismiss="modal">Tutup</a>
          </div>

        </div>
      </div>
    </div>
  </div>


  <audio id="ping" src="warning2.mp3" loop muted></audio>
  <script type="text/javascript">
    function displayClock() {
      var display = new Date().toLocaleString('id-ID');
      $('#jam').html(display)
      setTimeout(displayClock, 1000);
    }
    displayClock()
    $('#tidakaktif').show();
    $('#aktif').hide();

    var md = new MobileDetect(window.navigator.userAgent);
    var menu = false;
    if (menu) {
      $('#menu').show();
    } else {
      $('#menu').hide();
    }

    var gn;

    function init_gn() {
      var args = {
        logger: logger
      };

      gn = new GyroNorm();

      gn.init(args).then(function () {
        var isAvailable = gn.isAvailable();
        // if(!isAvailable.deviceOrientationAvailable) {
        //   logger({message:'Device orientation is not available.'});
        // } 

        // if(!isAvailable.accelerationAvailable && !isAvailable.accelerationIncludingGravityAvailable) {
        //   logger({message:'Device acceleration is not available.'});
        // } 

        // if(!isAvailable.rotationRateAvailable) {
        //   logger({message:'Device rotation rate is not available.'});
        // } 
        if (md.mobile() != null || md.phone() != null || md.tablet() != null || md.os() != null) {
          if (!isAvailable.accelerationAvailable) {
            logger({ message: 'Siap digunakan!' });
            logger({ message: 'Silahkan Klik Tombol "Start" untuk memulai' });
          } else {
            logger({ message: 'Sensor gyro acceleration tidak terdeteksi pada perangkat anda, harap muat ulang (reload) halaman ini.' });
            // window.location.reload();
            $('#settings').hide();
          }
        } else {
          logger({ message: 'Perangkat anda tidak didukung, harap gunakan smartphone/tablet yang mendukung Sensor Gyro Acceleration' });
          $('#settings').hide();
        }

        if ('wakeLock' in navigator) {
          isSupported = true;
          warn('Perangkat anda mendukung wakelock!');
        } else {
          wakeButton.disabled = true;
          warn('Perangkat anda tidak mendukung WakeLock, harap menggunakan google chrome terbaru!');
        }

        let wakeLock = null;
        async function wL() {
          // create an async function to request a wake lock
          try {
            wakeLock = await navigator.wakeLock.request('screen');
            warn('WakeLock Ok!');
          } catch (err) {
            // The Wake Lock request has failed - usually system related, such as battery.
            console.log(`${err.name}, ${err.message}`);
          }
        }
        wL()

        // start_gn();

      }).catch(function (e) {

        console.log(e);

      });
    }

    function logger(data) {
      $('#error-message').append(data.message + "\n");
    }

    function warn(data) {
      $('#error-message').append(data + "\n");
    }

    function stop_gn() {
      gn.stop();
      ping.muted = true;
      ping.pause();
      ping.currentTime = 0;
      warn('[STOP] Alarm Non Aktif!')
      $('#error-message').scrollTop($('#error-message')[0].scrollHeight);
      $('#sens').show();
      $('#tidakaktif').show();
      $('#aktif').hide();
    }


    function start_gn() {
      $('#error-message').attr('placeholder', 'Loading...');
      $('#error-message').html('');
      const start_alert = setTimeout(() => {
        gn.start(gnCallBack);
        warn('[START] Alarm Aktif!')
        $('#tidakaktif').hide();
        $('#aktif').show();
        $('#error-message').scrollTop($('#error-message')[0].scrollHeight);
        if (start_alert) clearTimeout(start_alert);
      }, 500)
      $('#sens').hide();
    }



    function gnCallBack(data) {
      $('#do_alpha').val(data.do.alpha);
      $('#do_beta').val(data.do.beta);
      $('#do_gamma').val(data.do.gamma);

      $('#dm_x').val(data.dm.x);
      $('#dm_y').val(data.dm.y);
      $('#dm_z').val(data.dm.z);

      $('#dm_gx').val(data.dm.gx);
      $('#dm_gy').val(data.dm.gy);
      $('#dm_gz').val(data.dm.gz);

      $('#dm_alpha').val(data.dm.alpha);
      $('#dm_beta').val(data.dm.beta);
      $('#dm_gamma').val(data.dm.gamma);

      // currValue.push(data.do.alpha + data.do.gamma)
      // var measure = data.dm.x + data.dm.y
      // $('#curr').html(measure)
      // warn(data.dm.x + ', ' + data.dm.y + ', ' + data.dm.z + ', ')
      if ($('#sele').val() == '1') {
        var x = -0.3;
        var y = -0.3;
        var z = -0.4;
        var px = 0.3;
        var py = 0.3;
        var pz = 0.4;
      } else if ($('#sele').val() == '2') {
        var x = -0.6;
        var y = -0.6;
        var z = -0.7;
        var px = 0.6;
        var py = 0.6;
        var pz = 0.7;
      } else if ($('#sele').val() == '3') {
        var x = -0.9;
        var y = -0.9;
        var z = -1.0;
        var px = 0.9;
        var py = 0.9;
        var pz = 1.0;
      } else if ($('#sele').val() == '4') {
        var x = -1.2;
        var y = -1.2;
        var z = -1.3;
        var px = 1.2;
        var py = 1.2;
        var pz = 1.0;
      } else if ($('#sele').val() == '5') {
        var x = -1.5;
        var y = -1.5;
        var z = -1.6;
        var px = 1.5;
        var py = 1.5;
        var pz = 1.6;
      }
      if (parseFloat(x) >= parseFloat(data.dm.x) || parseFloat(y) >= parseFloat(data.dm.y) || parseFloat(z) >= parseFloat(data.dm.z) || parseFloat(px) <= parseFloat(data.dm.x) || parseFloat(py) <= parseFloat(data.dm.y) || parseFloat(pz) <= parseFloat(data.dm.z)) {
        warn(new Date().toLocaleString('id-ID') + ' : Terjadi Getaran!')
        // warn(new Date().toLocaleString('id-ID') + ' : Terjadi Getaran' + parseFloat(data.dm.x) + ' | ' + parseFloat(data.dm.y) + ' | ' + parseFloat(data.dm.z))
        $('#error-message').scrollTop($('#error-message')[0].scrollHeight);
        ping.muted = true;
        ping.pause();
        ping.currentTime = 0;
        ping.muted = false;
        ping.volume = 1;
        ping.play();
      }
    }

    function norm_gn() {
      gn.normalizeGravity(true);
    }

    function org_gn() {
      gn.normalizeGravity(false);
    }

    function set_head_gn() {
      gn.setHeadDirection();
    }

    function showDO() {
      $('#do').show();
      $('#dm').hide();
      $('#btn-dm').removeClass('selected');
      $('#btn-do').addClass('selected');
    }

    function showDM() {
      $('#dm').show();
      $('#do').hide();
      $('#btn-do').removeClass('selected');
      $('#btn-dm').addClass('selected');
    }



  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
    crossorigin="anonymous"></script>
</body>

</html>